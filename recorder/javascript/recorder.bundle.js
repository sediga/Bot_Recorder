(()=>{function E(e){if(!e||!e.textContent)return"";let t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),s=[];for(;t.nextNode();){let r=t.currentNode.textContent.trim().replace(/\s+/g," ");r&&r.length<100&&s.push(r)}return s.length===0?"":s.sort((r,l)=>r.length-l.length)[0].replace(/["']/g,"")}function N(e){let t=e.tagName.toLowerCase(),s=e.getAttribute("role")||"",n=Array.from(e.classList).join(" ").toLowerCase();return["a","button"].includes(t)||["button","link"].includes(s)||e.hasAttribute("onclick")||e.hasAttribute("tabindex")||/cursor-pointer|clickable|btn|card|link|action|nav/i.test(n)}function P(e){for(;e&&e!==document.body&&!N(e);)e=e.parentElement;return e}function C(e){if(!e||e===document||e.nodeType!==1)return"";let t=P(e)||e,s=t.tagName.toLowerCase(),n=E(t);if(t.id)return`#${CSS.escape(t.id)}`;if(t.name)return`[name="${CSS.escape(t.name)}"]`;if(t.getAttribute("data-testid"))return`[data-testid="${CSS.escape(t.getAttribute("data-testid"))}"]`;if(t.getAttribute("aria-label"))return`[aria-label="${CSS.escape(t.getAttribute("aria-label"))}"]`;if(t.placeholder)return`[placeholder="${CSS.escape(t.placeholder)}"]`;if(s==="button"&&n)return`button:has-text("${n}")`;if(s==="a"&&n)return`a:has-text("${n}")`;let r=t.getAttribute("type"),l=t.getAttribute("role");if(s==="input"&&r==="button"&&t.value)return`input[type="button"][value="${CSS.escape(t.value)}"]`;if((l==="button"||l==="link")&&n)return`[role="${CSS.escape(l)}"]:has-text("${n}")`;let u=Array.from(t.classList).filter(p=>/^[a-zA-Z0-9_-]+$/.test(p)),f="";u.length&&(f="."+u.slice(0,3).map(CSS.escape).join("."));let d=`${s}${f}`;n&&(d+=`:has-text("${n}")`);let g=Array.from(document.querySelectorAll(s)).filter(p=>p.textContent?.includes(n));if(g.length>1){let p=g.indexOf(t);p>=0&&(d+=`:nth-of-type(${p+1})`)}return d}function L(e){let t=0,s=e.Tag,n=e.Attributes||{},r=(e.Classes||[]).join(" ").toLowerCase();return(["a","button"].includes(s)||e.Role==="button")&&(t+=10),e.Id&&(t+=8),(n["data-testid"]||n["aria-label"]||n.name)&&(t+=6),e.Text?.trim()&&(t+=5),["submit","button"].includes(e.Type)&&(t+=3),["input","select","textarea"].includes(s)&&(t+=3),(r.includes("btn")||r.includes("clickable"))&&(t+=3),t}function w(e){let t={};for(let s of e.attributes)s.name&&s.value&&(t[s.name]=s.value);return t}function $(e=1e3){return Array.from(document.querySelectorAll("*")).filter(n=>{let r=n.tagName.toLowerCase(),l=["a","button","input","select","textarea","label"],u=["section","article","nav","header","footer"],f=n.offsetParent!==null||getComputedStyle(n).display!=="none",d=n.getBoundingClientRect();return!(d.width===0||d.height===0)&&(l.includes(r)||u.includes(r)||f&&n.innerText?.trim())}).map(n=>{let r=f=>n.getAttribute(f),l=n.innerText?.trim().substring(0,100)||"",u={Tag:n.tagName.toLowerCase(),Id:r("id")||"",Classes:[...n.classList],Role:r("role")||"",Name:r("name")||"",Type:r("type")||"",Text:l,Attributes:w(n)};return{...u,Score:L(u)}}).filter(n=>n.Score>=3)}function A(e=1e3){return{Url:window.location.href,Timestamp:new Date().toISOString(),Source:"forced-delayed-snapshot",Elements:$(e)}}(function(){if(window.__recorderInjected)return;window.__recorderInjected=!0,console.log("[Botflows] Recorder script injected successfully"),window.sendSelectorSnapshot=()=>{if(typeof window.sendSelectorAnalysisToPython=="function"){let i={source:"manual-trigger",...A()};window.sendSelectorAnalysisToPython(i)}},window.sendSelectorAnalysisToPython=function(i){console.log("Sending selector snapshot to /api/snapshot",i),fetch("http://localhost:8000/api/snapshot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).catch(a=>console.warn("Failed to send snapshot to Python agent",a))},window.getSelectorAnalysisPayload=A;let e,t=null,s={selector:null,timestamp:0},n={selector:null,timestamp:0},r=i=>{let a=i.target,o=a.closest('a, button, input[type="button"], [role="button"]')||a,c=i.type;if(!o||typeof window.sendEventToPython!="function")return;let m=C(o),y=Date.now();if(c==="click"&&m===s.selector&&y-s.timestamp<80)return;if(c==="focus"){let b=o.tagName.toLowerCase();if(!["input","textarea","select"].includes(b))return}c==="click"&&(s={selector:m,timestamp:y}),c==="focus"&&(n={selector:m,timestamp:y});let h={action:c==="input"?"type":c,selector:m,timestamp:y,value:o.value||null,url:window.location.href,tagName:o.tagName||null,classList:Array.from(o.classList||[]),attributes:w(o),innerText:o.innerText||null,elementText:o.textContent||null};if(c==="input"&&(o.tagName==="INPUT"||o.tagName==="TEXTAREA")?(clearTimeout(e),t=o,e=setTimeout(()=>{t&&(window.sendEventToPython(h),window.parent.postMessage({type:"recorded-event",data:h},"*"),fetch("http://localhost:8000/api/stream_action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)}),t=null)},800)):(window.sendEventToPython(h),window.parent.postMessage({type:"recorded-event",data:h},"*"),fetch("http://localhost:8000/api/stream_action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)})),c==="click"&&typeof window.sendLogToPython=="function"){let b=o.parentElement?.tagName?.toLowerCase()||null,x=Array.from(o.parentElement?.children||[]).filter(T=>T!==o).map(T=>T.innerText.trim()).filter(Boolean);window.sendLogToPython({event:"click",selector:m,elementMeta:{tag:o.tagName.toLowerCase(),attributes:w(o),innerText:o.innerText?.trim(),parentTag:b,siblingText:x},timestamp:new Date().toISOString(),pageUrl:window.location.href})}};["click","focus","change","input"].forEach(i=>{document.addEventListener(i,r,!0)});let l=()=>{typeof window.sendUrlChangeToPython=="function"&&window.sendUrlChangeToPython(window.location.href)},u=()=>{document.body?new MutationObserver(l).observe(document.body,{childList:!0,subtree:!0}):setTimeout(u,100)};u();let f=i=>{let a=history[i];history[i]=function(...o){a.apply(this,o),l()}};window.addEventListener("popstate",l),l(),f("pushState"),f("replaceState");let d=new Set(JSON.parse(sessionStorage.getItem("snapshotSentUrls")||"[]"));function S(i){return!d.has(i)}function g(i){d.add(i),sessionStorage.setItem("snapshotSentUrls",JSON.stringify([...d]))}function p(i="auto-snapshot"){let a=window.location.href;if(typeof window.sendSelectorAnalysisToPython!="function")return;let o=window.getSelectorAnalysisPayload();if(!(Array.isArray(o.Elements)&&o.Elements.length>0)){console.warn(`Skipping snapshot for ${a}: No elements found.`);return}if(S(a)){let m={Source:i,Url:a,Timestamp:new Date().toISOString(),...o};console.log(`\u{1F4F8} Snapshot sent for ${a}`),window.sendSelectorAnalysisToPython(m),g(a)}else console.log(`Snapshot already sent for ${a}`)}function v(){window.addEventListener("load",()=>{setTimeout(()=>p("initial-load"),1e3)}),window.addEventListener("popstate",()=>{setTimeout(()=>p("history-nav"),1e3)});let i=a=>{let o=history[a];history[a]=function(...c){let m=o.apply(this,c);return setTimeout(()=>p(`history-${a}`),1e3),m}};i("pushState"),i("replaceState")}v()})();})();
