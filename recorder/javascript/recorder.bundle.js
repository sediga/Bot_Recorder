(()=>{function C(n){if(!n||!n.textContent)return"";let o=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,null),t=new Set;for(;o.nextNode();){let e=o.currentNode.textContent.trim().replace(/\s+/g," ");e&&e.length<100&&t.add(e)}return Array.from(t).join(" ").trim().replace(/["']/g,"")}function T(n){if(!n||n===document||n.nodeType!==1)return"";let t=n.closest('button, [role="button"], a, input[type="button"], [tabindex]')||n;if(t.id)return`#${CSS.escape(t.id)}`;if(t.name)return`[name="${CSS.escape(t.name)}"]`;if(t.getAttribute("data-testid"))return`[data-testid="${CSS.escape(t.getAttribute("data-testid"))}"]`;if(t.getAttribute("aria-label"))return`[aria-label="${CSS.escape(t.getAttribute("aria-label"))}"]`;if(t.placeholder)return`[placeholder="${CSS.escape(t.placeholder)}"]`;let e=t.tagName.toLowerCase(),c=t.getAttribute("type"),u=t.getAttribute("role"),a=C(t);if(e==="button"&&a)return`button:has-text("${a}")`;if(e==="input"&&c==="button"&&t.value)return`input[type="button"][value="${CSS.escape(t.value)}"]`;if((u==="button"||u==="link")&&a)return`[role="${CSS.escape(u)}"]:has-text("${a}")`;if(e==="a"&&a)return`a:has-text("${a}")`;if(["span","div","p","strong","li","label"].includes(e)&&a?.length>0&&a.length<100)return`${e}:has-text("${a}")`;let f=[],r=t;for(;r&&r.nodeType===1&&r!==document.body;){let h=r.tagName.toLowerCase(),S=[...r.classList].filter(g=>!/^\d+$/.test(g));S.length&&(h+="."+S.map(CSS.escape).join("."));let y=Array.from(r.parentNode.children).filter(g=>g.tagName===r.tagName);y.length>1&&(h+=`:nth-of-type(${y.indexOf(r)+1})`),f.unshift(h),r=r.parentNode}return f.join(" > ")}function N(n){let o=0,t=n.Tag,e=n.Attributes||{},c=(n.Classes||[]).join(" ").toLowerCase();return(["a","button"].includes(t)||n.Role==="button")&&(o+=10),n.Id&&(o+=8),(e["data-testid"]||e["aria-label"]||e.name)&&(o+=6),n.Text?.trim()&&(o+=5),["submit","button"].includes(n.Type)&&(o+=3),["input","select","textarea"].includes(t)&&(o+=3),(c.includes("btn")||c.includes("clickable"))&&(o+=3),o}function A(n){let o={};for(let t of n.attributes)t.name&&t.value&&(o[t.name]=t.value);return o}function E(n=1e3){return Array.from(document.querySelectorAll("*")).filter(e=>{let c=e.tagName.toLowerCase(),u=["a","button","input","select","textarea","label"],a=["section","article","nav","header","footer"],f=e.offsetParent!==null||getComputedStyle(e).display!=="none",r=e.getBoundingClientRect();return!(r.width===0||r.height===0)&&(u.includes(c)||a.includes(c)||f&&e.innerText?.trim())}).map(e=>{let c=f=>e.getAttribute(f),u=e.innerText?.trim().substring(0,100)||"",a={Tag:e.tagName.toLowerCase(),Id:c("id")||"",Classes:[...e.classList],Role:c("role")||"",Name:c("name")||"",Type:c("type")||"",Text:u,Attributes:A(e)};return{...a,Score:N(a)}}).filter(e=>e.Score>=10)}function x(n=1e3){return{Url:window.location.href,Timestamp:new Date().toISOString(),Source:"forced-delayed-snapshot",Elements:E(n)}}(function(){if(window.__recorderInjected)return;window.__recorderInjected=!0,console.log("[Botflows] Recorder script injected successfully"),window.sendSelectorSnapshot=()=>{if(typeof window.sendSelectorAnalysisToPython=="function"){let s={source:"manual-trigger",...x()};window.sendSelectorAnalysisToPython(s)}},window.sendSelectorAnalysisToPython=function(s){console.log("Sending selector snapshot to /api/snapshot",s),fetch("http://localhost:8000/api/snapshot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).catch(l=>console.warn("Failed to send snapshot to Python agent",l))},window.getSelectorAnalysisPayload=x;let n,o=null,t={selector:null,timestamp:0},e={selector:null,timestamp:0},c=s=>{let l=s.target,i=l.closest('a, button, input[type="button"], [role="button"]')||l,d=s.type;if(!i||typeof window.sendEventToPython!="function")return;let p=T(i),w=Date.now();if(!(d==="click"&&p===t.selector&&w-t.timestamp<150)&&!(d==="focus"&&p===e.selector&&w-e.timestamp<150)){if(d==="click"&&(t={selector:p,timestamp:w}),d==="focus"&&(e={selector:p,timestamp:w}),d==="input"&&(i.tagName==="INPUT"||i.tagName==="TEXTAREA"))clearTimeout(n),o=i,n=setTimeout(()=>{if(o){let m={action:"type",selector:T(o),timestamp:Date.now(),value:o.value,url:window.location.href};window.sendEventToPython(m),window.parent.postMessage({type:"recorded-event",data:m},"*"),fetch("http://localhost:8000/api/stream_action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)}),o=null}},800);else{let m={action:d,selector:p,timestamp:w,value:i.value||void 0,url:window.location.href};window.sendEventToPython(m),window.parent.postMessage({type:"recorded-event",data:m},"*"),fetch("http://localhost:8000/api/stream_action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)})}if(d==="click"&&typeof window.sendLogToPython=="function"){let m=i.parentElement?.tagName?.toLowerCase()||null,v=Array.from(i.parentElement?.children||[]).filter(b=>b!==i).map(b=>b.innerText.trim()).filter(Boolean);window.sendLogToPython({event:"click",selector:p,elementMeta:{tag:i.tagName.toLowerCase(),attributes:A(i),innerText:i.innerText.trim(),parentTag:m,siblingText:v},timestamp:new Date().toISOString(),pageUrl:window.location.href})}}};["click","focus","change","input"].forEach(s=>{document.addEventListener(s,c,!0)});let u=()=>{typeof window.sendUrlChangeToPython=="function"&&window.sendUrlChangeToPython(window.location.href)},a=()=>{document.body?new MutationObserver(u).observe(document.body,{childList:!0,subtree:!0}):setTimeout(a,100)};a();let f=s=>{let l=history[s];history[s]=function(...i){l.apply(this,i),u()}};window.addEventListener("popstate",u),u(),f("pushState"),f("replaceState");let r=new Set(JSON.parse(sessionStorage.getItem("snapshotSentUrls")||"[]"));function h(s){return!r.has(s)}function S(s){r.add(s),sessionStorage.setItem("snapshotSentUrls",JSON.stringify([...r]))}function y(s="auto-snapshot"){let l=window.location.href;if(typeof window.sendSelectorAnalysisToPython!="function")return;let i=window.getSelectorAnalysisPayload();if(!(Array.isArray(i.Elements)&&i.Elements.length>0)){console.warn(`Skipping snapshot for ${l}: No elements found.`);return}if(h(l)){let p={Source:s,Url:l,Timestamp:new Date().toISOString(),...i};console.log(`\u{1F4F8} Snapshot sent for ${l}`),window.sendSelectorAnalysisToPython(p),S(l)}else console.log(`Snapshot already sent for ${l}`)}function g(){window.addEventListener("load",()=>{setTimeout(()=>y("initial-load"),1e3)}),window.addEventListener("popstate",()=>{setTimeout(()=>y("history-nav"),1e3)});let s=l=>{let i=history[l];history[l]=function(...d){let p=i.apply(this,d);return setTimeout(()=>y(`history-${l}`),1e3),p}};s("pushState"),s("replaceState")}g()})();})();
