(()=>{function w(t){let o={};for(let e of t.attributes)e.name&&e.value&&(o[e.name]=e.value);return o}function L(t){if(!t||!t.textContent)return"";let o=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null),e=[];for(;o.nextNode();){let n=o.currentNode.textContent.trim().replace(/\s+/g," ");n&&n.length<100&&e.push(n)}return e.length===0?"":e.sort((n,c)=>n.length-c.length)[0].replace(/["']/g,"")}function T(t){let o=t.tagName.toLowerCase(),e=t.getAttribute("role")||"",s=Array.from(t.classList).join(" ").toLowerCase();return["a","button"].includes(o)||["button","link"].includes(e)||t.hasAttribute("onclick")||t.hasAttribute("tabindex")||/cursor-pointer|clickable|btn|card|link|action|nav/i.test(s)}function $(t){let o=["BODY","HTML","MAIN"],e=[/^min-h-screen$/,/^bg-/,/^text-/];return!t||o.includes(t.tagName)?!0:Array.from(t.classList).some(n=>e.some(c=>c.test(n)))}function _(t){for(;t&&t!==document.body&&!T(t)&&!$(t);)t=t.parentElement;return t}function k(t){if(!t||t.length<6)return!1;if(t.length>16)return!0;if(/^[A-Za-z0-9_-]{10,}$/.test(t)){let o=/[a-z]/.test(t)&&/[A-Z]/.test(t),e=/\d/.test(t);return o&&e}return!1}function y(t){if(!t||t===document||t.nodeType!==1)return"";if(t.tagName==="SPAN"&&t.textContent.trim()==="*"){let a=t.closest("label");if(a?.htmlFor)return`#${CSS.escape(a.htmlFor)}`;let i=t.closest("div")?.querySelector("input, textarea, select");if(i)return y(i)}if(t.tagName==="LABEL"&&t.htmlFor)return`#${CSS.escape(t.htmlFor)}`;if(["DIV","SPAN"].includes(t.tagName)){let a=t.querySelector("label[for]");if(a){let u=document.getElementById(a.htmlFor);if(u)return y(u)}let i=t.querySelector("input, textarea, select");if(i)return y(i)}let e=t.matches("input, textarea, select")?t:_(t)||t,s=e.tagName.toLowerCase(),n=L(e);if(e.getAttribute("data-testid"))return`[data-testid="${CSS.escape(e.getAttribute("data-testid"))}"]`;let c=e.getAttribute("aria-label");if(c){let a=e.closest('div[role="columnheader"][data-field]');if(a){let i=a.getAttribute("data-field");return`div[role="columnheader"][data-field="${CSS.escape(i)}"] [aria-label="${CSS.escape(c)}"]`}return`[aria-label="${CSS.escape(c)}"]`}if(e.id&&!k(e.id))return`#${CSS.escape(e.id)}`;if(e.name)return`[name="${CSS.escape(e.name)}"]`;if(e.placeholder)return`[placeholder="${CSS.escape(e.placeholder)}"]`;if(e.getAttribute("role")==="columnheader"&&e.hasAttribute("data-field"))return`div[role="columnheader"][data-field="${CSS.escape(e.getAttribute("data-field"))}"]`;if(s==="button"&&n)return`button:has-text("${n}")`;if(s==="a"&&n)return`a:has-text("${n}")`;let p=e.getAttribute("type"),m=e.getAttribute("role");if(s==="input"&&p==="button"&&e.value)return`input[type="button"][value="${CSS.escape(e.value)}"]`;if((m==="button"||m==="link")&&n)return`[role="${CSS.escape(m)}"]:has-text("${n}")`;let d=Array.from(e.classList).filter(a=>/^[a-zA-Z0-9_-]+$/.test(a)),g="";d.length&&(g="."+d.slice(0,3).map(CSS.escape).join("."));let f=`${s}${g}`;n&&(f+=`:has-text("${n}")`);let l=Array.from(document.querySelectorAll(s)).filter(a=>a.textContent?.includes(n));if(l.length>1){let a=l.indexOf(e);a>=0&&(f+=`:nth-of-type(${a+1})`)}return f.startsWith('body:has-text("*")')?"":f}function E(t){if(!(t instanceof Element))return"";let o=[];for(;t&&t.nodeType===Node.ELEMENT_NODE;){let e=t.nodeName.toLowerCase();if(t.id){e=`#${CSS.escape(t.id)}`,o.unshift(e);break}else{let n=(t.className||"").toString().trim().replace(/\s+/g,".");n&&(e+="."+n.replace(/^\.+/,""))}let s=t.parentNode;if(s){let n=Array.from(s.children).filter(c=>c.tagName===t.tagName);if(n.length>1){let c=n.indexOf(t)+1;e+=`:nth-child(${c})`}}o.unshift(e),t=t.parentNode}return o.join(" > ")}function S(t){if(!t)return null;let o=[],e=w(t),s=t.tagName.toLowerCase();if(t.id&&o.push({selector:`#${CSS.escape(t.id)}`,source:"id",score:100}),t.getAttribute("data-testid")&&o.push({selector:`[data-testid="${t.getAttribute("data-testid")}"]`,source:"data-testid",score:90}),t.getAttribute("aria-label")&&o.push({selector:`[aria-label="${t.getAttribute("aria-label")}"]`,source:"aria-label",score:85}),t.getAttribute("name")&&o.push({selector:`[name="${t.getAttribute("name")}"]`,source:"name",score:80}),t.classList.length){let c=`${s}.${[...t.classList].map(p=>CSS.escape(p)).join(".")}`;o.push({selector:c,source:"class",score:70})}let n=t.innerText?.trim();return n&&o.push({selector:`${s}:has-text("${n.slice(0,50)}")`,source:"has-text",score:40}),o.push({selector:x(t),source:"dom-path",score:30}),o.push({selector:v(t),source:"xpath",score:20}),{text:n,selectors:o,attributes:e,boundingBox:t.getBoundingClientRect?.()||null}}window.captureSelectors=S;function x(t){let o=[];for(;t&&t.nodeType===Node.ELEMENT_NODE;){let e=t.nodeName.toLowerCase();if(t.id)e+=`#${CSS.escape(t.id)}`;else{let s=Array.from(t.parentNode?.children||[]).filter(n=>n.nodeName===t.nodeName);if(s.length>1){let n=s.indexOf(t);e+=`:nth-of-type(${n+1})`}}o.unshift(e),t=t.parentElement}return o.join(" > ")}function v(t){if(t.id)return`//*[@id="${t.id}"]`;let o=[];for(;t&&t.nodeType===1;){let e=1,s=t.previousSibling;for(;s;)s.nodeType===1&&s.tagName===t.tagName&&e++,s=s.previousSibling;let n=t.tagName.toLowerCase(),c=e>1?`${n}[${e}]`:n;o.unshift(c),t=t.parentNode}return"/"+o.join("/")}window.getSmartSelectorLib={getSmartSelector:y,getDevtoolsLikeSelector:E};(function(){if(console.debug("[Botflows] Recorder script starting execution..."),window.__recorderInjected){console.debug(`[Botflows] Recorder already injected at ${window.__recorderInjectedTime}, skipping.`);return}window.__recorderInjected=!0,window.__recorderInjectedTime=new Date().toISOString(),console.debug("[Botflows] Recorder script injected successfully");let t={selector:null,timestamp:0},o={selector:null,timestamp:0},e=()=>window.__pickModeActive===!0;function s(){if(document.getElementById("__botflows_validation_overlay"))return;let r=document.createElement("div");r.id="__botflows_validation_overlay",Object.assign(r.style,{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",backgroundColor:"rgba(255, 255, 255, 0.6)",zIndex:999999,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"22px",fontFamily:"sans-serif",fontWeight:"bold",color:"#333"}),r.innerText="Validating action\u2026 Please wait",document.body.appendChild(r)}function n(){let r=document.getElementById("__botflows_validation_overlay");r&&r.remove()}window.hideValidationOverlay=n;let c=(r,l={})=>{if(e()){console.debug("[Botflows] In pick mode \u2014 event suppressed:",r.type);return}if(window.__pendingValidation){console.debug("[Botflows] Skipping event while previous validation is pending");return}let a=r.target,i=a.closest('a, button, input[type="button"], [role="button"]')||a,u=r.type;if(!i||i===document||i===document.body||!document.contains(i)||typeof window.sendEventToPython!="function"){console.debug("[Botflows] Ignoring untrackable target:",i);return}let N={tagName:i.tagName.toLowerCase(),id:i.id||null,name:i.getAttribute("name")||null,classList:Array.from(i.classList||[]),attributes:w(i),text:i.innerText?.trim()||"",elementText:i.textContent?.trim()||"",boundingBox:i.getBoundingClientRect?.(),outerHTML:i.outerHTML||"",domPath:x(i),xpath:v(i)},b=Date.now(),h=S(i).selector;if(u==="click"&&h===t.selector&&b-t.timestamp<80){console.debug("[Botflows] Suppressed duplicate click:",h);return}if(u==="focus"){let A=i.tagName.toLowerCase();if(!["input","textarea","select"].includes(A)){console.debug("[Botflows] Ignored focus event on non-input element:",A);return}}u==="click"&&(t={selector:h,timestamp:b}),u==="focus"&&(o={selector:h,timestamp:b});let C={action:u==="input"?"type":u,url:window.location.href,value:i.value||null,timestamp:b,...N};console.debug("[Botflows] Sending event to Python:",C),window.__pendingValidation=!0,s(),window.sendEventToPython(C),p()};["click","focus","change","dblclick"].forEach(r=>{document.addEventListener(r,c,!0),console.debug(`[Botflows] Event listener attached for ${r}`)});function p(r=5e3){return new Promise(l=>{let a=i=>{i.data?.type==="validationComplete"&&(window.removeEventListener("message",a),window.__pendingValidation=!1,n(),l())};window.addEventListener("message",a),setTimeout(()=>{window.removeEventListener("message",a),console.warn("[Botflows] Validation timeout"),window.__pendingValidation=!1,n(),l()},r)})}document.addEventListener("blur",r=>{if(e()){console.debug("[Botflows] Blur event suppressed in pick mode");return}let l=r.target;l.matches("input, textarea, select")&&(console.debug("[Botflows] Blur captured as type event"),c(r,{action:"type",value:l.value}))},!0);let m=window.location.href,d=()=>{let r=window.location.href;r!==m&&typeof window.sendUrlChangeToPython=="function"&&(m=r,console.debug("[Botflows] Detected SPA URL change:",r),window.sendUrlChangeToPython(r))},g=()=>{document.body?(console.debug("[Botflows] Setting up mutation observer for body"),new MutationObserver(d).observe(document.body,{childList:!0,subtree:!0})):setTimeout(g,100)};g();let f=r=>{let l=history[r];history[r]=function(...a){l.apply(this,a),console.debug(`[Botflows] Intercepted history.${r}`),d()}};window.addEventListener("popstate",d),d(),f("pushState"),f("replaceState")})();})();
