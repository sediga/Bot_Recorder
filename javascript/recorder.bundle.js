(()=>{function z(t){let s={};for(let n of t.attributes)n.name&&n.value&&(s[n.name]=n.value);return s}function et(t){if(!t||!t.textContent)return"";let s=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null),n=[];for(;s.nextNode();){let a=s.currentNode.textContent.trim().replace(/\s+/g," ");a&&a.length<100&&n.push(a)}return n.length===0?"":n.sort((a,d)=>a.length-d.length)[0].replace(/["']/g,"")}function ot(t){let s=t.tagName.toLowerCase(),n=t.getAttribute("role")||"",l=Array.from(t.classList).join(" ").toLowerCase();return["a","button"].includes(s)||["button","link"].includes(n)||t.hasAttribute("onclick")||t.hasAttribute("tabindex")||/cursor-pointer|clickable|btn|card|link|action|nav/i.test(l)}function nt(t){let s=["BODY","HTML","MAIN"],n=[/^min-h-screen$/,/^bg-/,/^text-/];return!t||s.includes(t.tagName)?!0:Array.from(t.classList).some(a=>n.some(d=>d.test(a)))}function it(t){for(;t&&t!==document.body&&!ot(t)&&!nt(t);)t=t.parentElement;return t}function rt(t){if(!t||t.length<6)return!1;if(t.length>16)return!0;if(/^[A-Za-z0-9_-]{10,}$/.test(t)){let s=/[a-z]/.test(t)&&/[A-Z]/.test(t),n=/\d/.test(t);return s&&n}return!1}function D(t){if(!t||t===document||t.nodeType!==1)return"";if(t.tagName==="SPAN"&&t.textContent.trim()==="*"){let c=t.closest("label");if(c?.htmlFor)return`#${CSS.escape(c.htmlFor)}`;let g=t.closest("div")?.querySelector("input, textarea, select");if(g)return D(g)}if(t.tagName==="LABEL"&&t.htmlFor)return`#${CSS.escape(t.htmlFor)}`;if(["DIV","SPAN"].includes(t.tagName)){let c=t.querySelector("label[for]");if(c){let B=document.getElementById(c.htmlFor);if(B)return D(B)}let g=t.querySelector("input, textarea, select");if(g)return D(g)}let n=t.matches("input, textarea, select")?t:it(t)||t,l=n.tagName.toLowerCase(),a=et(n);if(n.getAttribute("data-testid"))return`[data-testid="${CSS.escape(n.getAttribute("data-testid"))}"]`;let d=n.getAttribute("aria-label");if(d){let c=n.closest('div[role="columnheader"][data-field]');if(c){let g=c.getAttribute("data-field");return`div[role="columnheader"][data-field="${CSS.escape(g)}"] [aria-label="${CSS.escape(d)}"]`}return`[aria-label="${CSS.escape(d)}"]`}if(n.id&&!rt(n.id))return`#${CSS.escape(n.id)}`;if(n.name)return`[name="${CSS.escape(n.name)}"]`;if(n.placeholder)return`[placeholder="${CSS.escape(n.placeholder)}"]`;if(n.getAttribute("role")==="columnheader"&&n.hasAttribute("data-field"))return`div[role="columnheader"][data-field="${CSS.escape(n.getAttribute("data-field"))}"]`;if(l==="button"&&a)return`button:has-text("${a}")`;if(l==="a"&&a)return`a:has-text("${a}")`;let $=n.getAttribute("type"),N=n.getAttribute("role");if(l==="input"&&$==="button"&&n.value)return`input[type="button"][value="${CSS.escape(n.value)}"]`;if((N==="button"||N==="link")&&a)return`[role="${CSS.escape(N)}"]:has-text("${a}")`;let k=Array.from(n.classList).filter(c=>/^[a-zA-Z0-9_-]+$/.test(c)),j="";k.length&&(j="."+k.slice(0,3).map(CSS.escape).join("."));let S=`${l}${j}`;a&&(S+=`:has-text("${a}")`);let C=Array.from(document.querySelectorAll(l)).filter(c=>c.textContent?.includes(a));if(C.length>1){let c=C.indexOf(n);c>=0&&(S+=`:nth-of-type(${c+1})`)}return S.startsWith('body:has-text("*")')?"":S}function at(t){if(!(t instanceof Element))return"";let s=[];for(;t&&t.nodeType===Node.ELEMENT_NODE;){let n=t.nodeName.toLowerCase();if(t.id){n=`#${CSS.escape(t.id)}`,s.unshift(n);break}else{let a=(t.className||"").toString().trim().replace(/\s+/g,".");a&&(n+="."+a.replace(/^\.+/,""))}let l=t.parentNode;if(l){let a=Array.from(l.children).filter(d=>d.tagName===t.tagName);if(a.length>1){let d=a.indexOf(t)+1;n+=`:nth-child(${d})`}}s.unshift(n),t=t.parentNode}return s.join(" > ")}function H(t){if(!t)return null;let s=[],n=z(t),l=t.tagName.toLowerCase();if(t.id&&s.push({selector:`#${CSS.escape(t.id)}`,source:"id",score:100}),t.getAttribute("data-testid")&&s.push({selector:`[data-testid="${t.getAttribute("data-testid")}"]`,source:"data-testid",score:90}),t.getAttribute("aria-label")&&s.push({selector:`[aria-label="${t.getAttribute("aria-label")}"]`,source:"aria-label",score:85}),t.getAttribute("name")&&s.push({selector:`[name="${t.getAttribute("name")}"]`,source:"name",score:80}),t.classList.length){let d=`${l}.${[...t.classList].map($=>CSS.escape($)).join(".")}`;s.push({selector:d,source:"class",score:70})}let a=t.innerText?.trim();return a&&s.push({selector:`${l}:has-text("${a.slice(0,50)}")`,source:"has-text",score:40}),s.push({selector:U(t),source:"dom-path",score:30}),s.push({selector:W(t),source:"xpath",score:20}),{text:a,selectors:s,attributes:n,boundingBox:t.getBoundingClientRect?.()||null}}window.captureSelectors=H;function U(t){let s=[];for(;t&&t.nodeType===Node.ELEMENT_NODE;){let n=t.nodeName.toLowerCase();if(t.id)n+=`#${CSS.escape(t.id)}`;else{let l=Array.from(t.parentNode?.children||[]).filter(a=>a.nodeName===t.nodeName);if(l.length>1){let a=l.indexOf(t);n+=`:nth-of-type(${a+1})`}}s.unshift(n),t=t.parentElement}return s.join(" > ")}function W(t){if(t.id)return`//*[@id="${t.id}"]`;let s=[];for(;t&&t.nodeType===1;){let n=1,l=t.previousSibling;for(;l;)l.nodeType===1&&l.tagName===t.tagName&&n++,l=l.previousSibling;let a=t.tagName.toLowerCase(),d=n>1?`${a}[${n}]`:a;s.unshift(d),t=t.parentNode}return"/"+s.join("/")}window.getSmartSelectorLib={getSmartSelector:D,getDevtoolsLikeSelector:at};(function(){if(console.debug("[Botflows] Recorder script starting execution..."),window.__recorderInjected){console.debug(`[Botflows] Recorder already injected at ${window.__recorderInjectedTime}, skipping.`);return}window.__recorderInjected=!0,window.__recorderInjectedTime=new Date().toISOString(),console.debug("[Botflows] Recorder script injected successfully");let t={selector:null,timestamp:0},s={selector:null,timestamp:0},n=()=>window.__pickModeActive===!0;function l(){if(document.getElementById("__botflows_validation_overlay"))return;let r=document.createElement("div");r.id="__botflows_validation_overlay",Object.assign(r.style,{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",backgroundColor:"rgba(255, 255, 255, 0.6)",zIndex:999999,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"22px",fontFamily:"sans-serif",fontWeight:"bold",color:"#333"}),r.innerText="Validating action\u2026 Please wait",document.body.appendChild(r)}function a(r){if(document.getElementById("botflows-prompt"))return;window.__pendingValidation=!0;let o=document.createElement("div");o.id="botflows-prompt",o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100vw",o.style.height="100vh",o.style.backgroundColor="rgba(0,0,0,0.5)",o.style.zIndex=9999,o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.fontFamily="Arial, sans-serif",o.setAttribute("data-botflows-ui","true");let i=document.createElement("div");i.style.background="white",i.style.padding="20px",i.style.borderRadius="12px",i.style.width="460px",i.style.boxShadow="0 5px 15px rgba(0,0,0,0.3)",i.setAttribute("data-botflows-ui","true"),i.innerHTML=`
      <h2 style="margin-top:0; font-size:20px; color:#333;">\u{1F501} Botflows \u2013 Row Action Condition</h2>
      <p style="margin: 10px 0;">Only click this element if a column in the current row matches:</p>
      
      <label for="grid-column">Column Name:</label>
      <input id="grid-column" placeholder="e.g. Status" style="width:100%; padding:8px; font-size:14px; margin-bottom:10px;" />

      <label for="grid-value">Equals Value:</label>
      <input id="grid-value" placeholder="e.g. Pending" style="width:100%; padding:8px; font-size:14px;" />

      <div style="margin-top:20px; display: flex; justify-content: flex-end; gap: 10px;">
        <button id="cancel-btn" style="padding: 6px 12px; background: #eee; border: 1px solid #ccc;">Cancel</button>
        <button id="submit-btn" style="padding: 6px 12px; background: #2563eb; color: white; border: none;">Submit</button>
      </div>
    `,o.appendChild(i),document.body.appendChild(o);let e=i.querySelector("#grid-column"),u=i.querySelector("#grid-value");e.focus(),i.querySelector("#cancel-btn").onclick=()=>{document.body.removeChild(o),window.__pendingValidation=!1,r(null,null)},i.querySelector("#submit-btn").onclick=()=>{let p=e.value.trim(),v=u.value.trim();document.body.removeChild(o),window.__pendingValidation=!1,r(p||null,v||null)}}function d(r){if(document.getElementById("botflows-prompt"))return;window.__pendingValidation=!0;let o=document.createElement("div");o.id="botflows-prompt",o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100vw",o.style.height="100vh",o.style.backgroundColor="rgba(0,0,0,0.5)",o.style.zIndex=9999,o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.fontFamily="Arial, sans-serif",o.setAttribute("data-botflows-ui","true");let i=document.createElement("div");i.style.background="white",i.style.padding="20px",i.style.borderRadius="12px",i.style.width="460px",i.style.boxShadow="0 5px 15px rgba(0,0,0,0.3)",i.setAttribute("data-botflows-ui","true");let e=[{value:"firstActiveDate",label:"First Active Date"},{value:"today",label:"Today"},{value:"nextWeekday",label:"Next Weekday"},{value:"specificDate",label:"Specific Date (Coming Soon)"}];i.innerHTML=`
      <h2 style="margin-top:0; font-size:20px; color:#333;">\u{1F4C5} Botflows \u2013 Date Picker Criteria</h2>
      <p style="margin: 10px 0;">Choose how this date should be selected during automation:</p>

      <label for="botflows-date-criteria">Date Selection:</label>
      <select id="botflows-date-criteria" style="width:100%; padding:8px; font-size:14px;">
        ${e.map(p=>`<option value="${p.value}">${p.label}</option>`).join("")}
      </select>

      <div style="margin-top:20px; display: flex; justify-content: flex-end; gap: 10px;">
        <button id="cancel-btn" style="padding: 6px 12px; background: #eee; border: 1px solid #ccc;">Cancel</button>
        <button id="submit-btn" style="padding: 6px 12px; background: #2563eb; color: white; border: none;">Submit</button>
      </div>
    `,o.appendChild(i),document.body.appendChild(o);let u=i.querySelector("#botflows-date-criteria");i.querySelector("#cancel-btn").onclick=()=>{document.body.removeChild(o),window.__pendingValidation=!1,r(null)},i.querySelector("#submit-btn").onclick=()=>{let p=u.value;document.body.removeChild(o),window.__pendingValidation=!1,r(p)}}function $(r,o){if(document.getElementById("botflows-prompt"))return;let i=document.createElement("div");i.id="botflows-prompt",i.style.position="fixed",i.style.top="0",i.style.left="0",i.style.width="100vw",i.style.height="100vh",i.style.backgroundColor="rgba(0,0,0,0.5)",i.style.zIndex=9999,i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.fontFamily="Arial, sans-serif",i.setAttribute("data-botflows-ui","true");let e=document.createElement("div");e.style.background="white",e.style.padding="20px",e.style.borderRadius="12px",e.style.width="460px",e.style.boxShadow="0 5px 15px rgba(0,0,0,0.3)",e.setAttribute("data-botflows-ui","true");let u=null,p="",v="regex";function q(){return u==null?"":r[u]?.preview||""}function b(f){if(!f)return"";try{if(v==="regex"){let A=new RegExp(p),_=f.match(A);return _?.[1]||_?.[0]||"(no match)"}else if(v==="js")return new Function("value",`return value${p}`)(f)}catch{return"(error)"}return f}window.getTransformedPreview=b;function I(){e.querySelector("#botflows-raw-value").textContent=q(),e.querySelector("#botflows-transformed-value").textContent=b(q())}e.innerHTML=`
      <h2 style="margin-top:0; font-size:20px; color:#333;">\u{1F501} Botflows \u2013 Map Field to Column</h2>
      <p style="margin: 10px 0;">Select a column to map this input to:</p>
      <select id="column-select" style="width:100%; padding:8px; font-size:14px;">
        <option value="">-- Skip Mapping --</option>
        ${r.map((f,A)=>`<option value="${A}">${f.label}</option>`).join("")}
      </select>
      <p style="margin: 10px 0 5px;">Transform type:</p>
      <select id="transform-type" style="width:100%; padding:8px; font-size:14px;">
        <option value="regex">Regex</option>
        <option value="js">JS Expression (e.g. .trim(), .slice(0,3))</option>
      </select>
      <p style="margin: 10px 0 5px;">Transformation rule:</p>
      <input id="transform-input" type="text" placeholder="e.g., (.+?)\\s or .trim()" style="width:100%; padding:8px; font-size:14px;" />
      <div style="margin-top:16px; font-style:italic;">
        <div>Raw: <span id="botflows-raw-value" style="font-weight:bold;"></span></div>
        <div>Result: <span id="botflows-transformed-value" style="font-weight:bold;"></span></div>
      </div>
      <div style="margin-top:20px; display: flex; justify-content: flex-end; gap: 10px;">
        <button id="cancel-btn" style="padding: 6px 12px; background: #eee; border: 1px solid #ccc;">Cancel</button>
        <button id="submit-btn" style="padding: 6px 12px; background: #2563eb; color: white; border: none;">Submit</button>
      </div>
    `,i.appendChild(e),document.body.appendChild(i),e.querySelector("#column-select").onchange=f=>{u=parseInt(f.target.value),I()},e.querySelector("#transform-input").oninput=f=>{p=f.target.value,I()},e.querySelector("#transform-type").onchange=f=>{v=f.target.value,I()},e.querySelector("#cancel-btn").onclick=()=>{document.body.removeChild(i),o(null)},e.querySelector("#submit-btn").onclick=()=>{document.body.removeChild(i),o(u!=null?{index:u,transform:p,transformType:v}:null)}}function N(r){if(!r)return[];if(r.type==="gridExtract"){debugger;return(r.columnMappings||[]).map((o,i)=>({label:`${i+1}. ${o.header?.header||"Unnamed"}`,value:o.header?.header||"",preview:o.preview||"sample"}))}return r.type==="apiExtract"?(r.fields||[]).map(o=>({label:o.path,value:o.path,preview:o.preview||"sample"})):[]}function k(){let r=document.getElementById("__botflows_validation_overlay");r&&r.remove()}window.hideValidationOverlay=k,window.showValidationOverlay=l;function j(r){return r.closest("[data-botflows-ui]")}let S=(r,o={})=>{if(window.__botflows_replaying__){console.debug("[Botflows] In replay mode \u2014 event suppressed:",r.type);return}if(n()){console.debug("[Botflows] In pick mode \u2014 event suppressed:",r.type);return}if(window.__pendingValidation){console.debug("[Botflows] Skipping event while previous validation is pending");return}let i=r.target,e=i.closest('a, button, input[type="button"], [role="button"]')||i,u=r.type;if(j(e)){console.debug("[Botflows] Skipping event from Botflows UI:",e);return}if(!e||e===document||e===document.body||!document.contains(e)||typeof window.sendEventToPython!="function"){console.debug("[Botflows] Ignoring untrackable target:",e);return}let p=Date.now(),v=H(e);function q(y){return!y||!y.selectors||y.selectors.length===0?null:y.selectors.reduce((T,h)=>T.score>h.score?T:h).selector}let b=q(v),I={tagName:e.tagName.toLowerCase(),id:e.id||null,name:e.getAttribute("name")||null,classList:Array.from(e.classList||[]),attributes:z(e),text:e.innerText?.trim()||"",elementText:e.textContent?.trim()||"",boundingBox:e.getBoundingClientRect?.(),outerHTML:e.outerHTML||"",selector:b||"",domPath:U(e),xpath:W(e)};if(u==="click"&&b===t.selector&&p-t.timestamp<80){console.debug("[Botflows] Suppressed duplicate click:",b);return}if(u==="focus"){let y=e.tagName.toLowerCase();if(!["input","textarea","select"].includes(y)){console.debug("[Botflows] Ignored focus event on non-input element:",y);return}}u==="click"&&(t={selector:b,timestamp:p}),u==="focus"&&(s={selector:b,timestamp:p});let f={action:u==="input"?"type":u,url:window.location.href,value:e.value||null,timestamp:p,...I},A=window.loopContext?.sourceStep,_=N(A);if(window.loopContext?.active&&_.length&&["input","select","textarea","a","button"].includes(e.tagName.toLowerCase())&&e.getAttribute("data-botflows-mapped")!==window.loopContext?.loopName){if(typeof e.value=="string"&&/\{\{.*\}\}/.test(e.value)){let T=e.value.match(/\{\{(.*?)\}\}/)?.[1]?.trim(),h=_.find(J=>J.value===T);if(h){e.setAttribute("data-botflows-mapped",window.loopContext?.loopName||"global"),e.setAttribute("data-dynamic-value",`{{${h.value}}}`),e.dispatchEvent(new Event("change",{bubbles:!0})),console.debug(`[Botflows] Auto-mapped input to: {{${h.value}}}`),w();return}}let y=["select","a","button","div"].includes(e.tagName.toLowerCase())||["combobox","link","option"].includes(e.getAttribute("role"));debugger;if(y||e.tagName.toLowerCase()==="input"){debugger;let O=(e.getAttribute("type")||"").toLowerCase(),T=(e.getAttribute("name")||"").toLowerCase(),h=(e.className||"").toLowerCase();if(u==="click"&&window.loopContext?.active){let tt=function(M){return M.tagName.toLowerCase()==="input"&&["text","search"].includes(Q)?"type":M.tagName.toLowerCase()==="select"?"select":(["button","a","div"].includes(F)||["button","link"].includes(Y),"click")},m=e.closest("[role='row'], tr, .MuiDataGrid-row, .sticky-row, [data-row], [data-rowindex]");if(!m){console.warn("[Botflows] No row found"),w();return}let R=m.closest("[role='grid'], table, .MuiDataGrid-root, .patient-list-grid, [data-grid]"),E=Array.from(m.querySelectorAll("[role='gridcell'], [role='cell']"));E.length===0&&(E=Array.from(m.children||[]));let x=E.findIndex(M=>M.contains(e)),L=window.loopContext?.sourceStep?.columnMappings||[];if(x<0||x>=L.length){console.warn("[Botflows] Couldn't resolve clicked column index"),w();return}let P=L[x]?.header||`Column ${x+1}`,F=e.tagName.toLowerCase(),Y=e.getAttribute("role")?.toLowerCase()||"",Q=e.getAttribute("type")?.toLowerCase()||"",K=tt(e);window.__botflowsTempStepExtras__={type:"clickInColumn",columnIndex:x,columnHeader:P,actionType:K,targetTag:F,selector:b},console.debug(`[Botflows] Auto-captured smart column action \u2192 column ${x} (${P}), action: ${K}, tag: ${F}`),w();return}if(O==="date"||T.includes("date")||h.includes("date")||h.includes("calendar")){debugger;d(m=>{if(!m){e.setAttribute("data-botflows-mapped",window.loopContext?.loopName||"global"),w();return}e.setAttribute("data-botflows-date-criteria",m),e.setAttribute("data-botflows-mapped",window.loopContext?.loopName||"global"),window.__botflowsTempStepExtras__={dateCriteria:m},w()});return}$(_,m=>{if(!m){e.setAttribute("data-botflows-mapped",window.loopContext?.loopName||"global"),w();return}let R=_[m.index],E=`{{${R.value}}}`,x=R.preview||"sample",L=m.transformType||null,P=m.transform||"",F=window.getTransformedPreview(x)||x;e.value=F,e.setAttribute("data-botflows-mapped",window.loopContext?.loopName||"global"),e.setAttribute("data-dynamic-value",E),L&&(e.setAttribute("data-transform-type",L),e.setAttribute("data-transform",P)),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),console.debug(`[Botflows] Mapped input to: ${E} (with ${L||"no"} transform: ${P})`),w()});return}}w();function w(){window.__botflowsTempStepExtras__&&(Object.assign(f,window.__botflowsTempStepExtras__),window.__botflowsTempStepExtras__=null),console.debug("[Botflows] Sending event to Python:",f),window.__pendingValidation=!0,l(),window.sendEventToPython(f),Z()}};["click","focus","change","dblclick"].forEach(r=>{document.addEventListener(r,S,!0),console.debug(`[Botflows] Event listener attached for ${r}`)});function Z(r=5e3){return new Promise(o=>{let i=e=>{e.data?.type==="validationComplete"&&(window.removeEventListener("message",i),window.__pendingValidation=!1,k(),o())};window.addEventListener("message",i),setTimeout(()=>{window.removeEventListener("message",i),console.warn("[Botflows] Validation timeout"),window.__pendingValidation=!1,k(),o()},r)})}let C=null,c="";function g(r){let o=r.value||"";if(o!==c){c=o;let i=new Event("input");i.target=r,S(i)}}document.addEventListener("input",r=>{if(n())return;let o=r.target;o.matches("input, textarea")&&(clearTimeout(C),C=setTimeout(()=>g(o),300))},!0),document.addEventListener("keydown",r=>{if(n())return;let o=r.target;o.matches("input, textarea")&&r.key==="Enter"&&(clearTimeout(C),g(o))},!0),document.addEventListener("blur",r=>{if(n())return;let o=r.target;o.matches("input, textarea, select")&&(clearTimeout(C),g(o))},!0);let B=window.location.href,V=()=>{let r=window.location.href;r!==B&&typeof window.sendUrlChangeToPython=="function"&&(B=r,console.debug("[Botflows] Detected SPA URL change:",r),window.sendUrlChangeToPython(r))},G=()=>{document.body?(console.debug("[Botflows] Setting up mutation observer for body"),new MutationObserver(V).observe(document.body,{childList:!0,subtree:!0})):setTimeout(G,100)};G();let X=r=>{let o=history[r];history[r]=function(...i){o.apply(this,i),console.debug(`[Botflows] Intercepted history.${r}`),V()}};window.addEventListener("popstate",V),V(),X("pushState"),X("replaceState")})();})();
