(()=>{function B(t){let i={};for(let e of t.attributes)e.name&&e.value&&(i[e.name]=e.value);return i}function q(t){if(!t||!t.textContent)return"";let i=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null),e=[];for(;i.nextNode();){let r=i.currentNode.textContent.trim().replace(/\s+/g," ");r&&r.length<100&&e.push(r)}return e.length===0?"":e.sort((r,u)=>r.length-u.length)[0].replace(/["']/g,"")}function U(t){let i=t.tagName.toLowerCase(),e=t.getAttribute("role")||"",l=Array.from(t.classList).join(" ").toLowerCase();return["a","button"].includes(i)||["button","link"].includes(e)||t.hasAttribute("onclick")||t.hasAttribute("tabindex")||/cursor-pointer|clickable|btn|card|link|action|nav/i.test(l)}function D(t){let i=["BODY","HTML","MAIN"],e=[/^min-h-screen$/,/^bg-/,/^text-/];return!t||i.includes(t.tagName)?!0:Array.from(t.classList).some(r=>e.some(u=>u.test(r)))}function H(t){for(;t&&t!==document.body&&!U(t)&&!D(t);)t=t.parentElement;return t}function Z(t){if(!t||t.length<6)return!1;if(t.length>16)return!0;if(/^[A-Za-z0-9_-]{10,}$/.test(t)){let i=/[a-z]/.test(t)&&/[A-Z]/.test(t),e=/\d/.test(t);return i&&e}return!1}function I(t){if(!t||t===document||t.nodeType!==1)return"";if(t.tagName==="SPAN"&&t.textContent.trim()==="*"){let c=t.closest("label");if(c?.htmlFor)return`#${CSS.escape(c.htmlFor)}`;let p=t.closest("div")?.querySelector("input, textarea, select");if(p)return I(p)}if(t.tagName==="LABEL"&&t.htmlFor)return`#${CSS.escape(t.htmlFor)}`;if(["DIV","SPAN"].includes(t.tagName)){let c=t.querySelector("label[for]");if(c){let T=document.getElementById(c.htmlFor);if(T)return I(T)}let p=t.querySelector("input, textarea, select");if(p)return I(p)}let e=t.matches("input, textarea, select")?t:H(t)||t,l=e.tagName.toLowerCase(),r=q(e);if(e.getAttribute("data-testid"))return`[data-testid="${CSS.escape(e.getAttribute("data-testid"))}"]`;let u=e.getAttribute("aria-label");if(u){let c=e.closest('div[role="columnheader"][data-field]');if(c){let p=c.getAttribute("data-field");return`div[role="columnheader"][data-field="${CSS.escape(p)}"] [aria-label="${CSS.escape(u)}"]`}return`[aria-label="${CSS.escape(u)}"]`}if(e.id&&!Z(e.id))return`#${CSS.escape(e.id)}`;if(e.name)return`[name="${CSS.escape(e.name)}"]`;if(e.placeholder)return`[placeholder="${CSS.escape(e.placeholder)}"]`;if(e.getAttribute("role")==="columnheader"&&e.hasAttribute("data-field"))return`div[role="columnheader"][data-field="${CSS.escape(e.getAttribute("data-field"))}"]`;if(l==="button"&&r)return`button:has-text("${r}")`;if(l==="a"&&r)return`a:has-text("${r}")`;let w=e.getAttribute("type"),C=e.getAttribute("role");if(l==="input"&&w==="button"&&e.value)return`input[type="button"][value="${CSS.escape(e.value)}"]`;if((C==="button"||C==="link")&&r)return`[role="${CSS.escape(C)}"]:has-text("${r}")`;let A=Array.from(e.classList).filter(c=>/^[a-zA-Z0-9_-]+$/.test(c)),L="";A.length&&(L="."+A.slice(0,3).map(CSS.escape).join("."));let g=`${l}${L}`;r&&(g+=`:has-text("${r}")`);let y=Array.from(document.querySelectorAll(l)).filter(c=>c.textContent?.includes(r));if(y.length>1){let c=y.indexOf(e);c>=0&&(g+=`:nth-of-type(${c+1})`)}return g.startsWith('body:has-text("*")')?"":g}function W(t){if(!(t instanceof Element))return"";let i=[];for(;t&&t.nodeType===Node.ELEMENT_NODE;){let e=t.nodeName.toLowerCase();if(t.id){e=`#${CSS.escape(t.id)}`,i.unshift(e);break}else{let r=(t.className||"").toString().trim().replace(/\s+/g,".");r&&(e+="."+r.replace(/^\.+/,""))}let l=t.parentNode;if(l){let r=Array.from(l.children).filter(u=>u.tagName===t.tagName);if(r.length>1){let u=r.indexOf(t)+1;e+=`:nth-child(${u})`}}i.unshift(e),t=t.parentNode}return i.join(" > ")}function j(t){if(!t)return null;let i=[],e=B(t),l=t.tagName.toLowerCase();if(t.id&&i.push({selector:`#${CSS.escape(t.id)}`,source:"id",score:100}),t.getAttribute("data-testid")&&i.push({selector:`[data-testid="${t.getAttribute("data-testid")}"]`,source:"data-testid",score:90}),t.getAttribute("aria-label")&&i.push({selector:`[aria-label="${t.getAttribute("aria-label")}"]`,source:"aria-label",score:85}),t.getAttribute("name")&&i.push({selector:`[name="${t.getAttribute("name")}"]`,source:"name",score:80}),t.classList.length){let u=`${l}.${[...t.classList].map(w=>CSS.escape(w)).join(".")}`;i.push({selector:u,source:"class",score:70})}let r=t.innerText?.trim();return r&&i.push({selector:`${l}:has-text("${r.slice(0,50)}")`,source:"has-text",score:40}),i.push({selector:V(t),source:"dom-path",score:30}),i.push({selector:O(t),source:"xpath",score:20}),{text:r,selectors:i,attributes:e,boundingBox:t.getBoundingClientRect?.()||null}}window.captureSelectors=j;function V(t){let i=[];for(;t&&t.nodeType===Node.ELEMENT_NODE;){let e=t.nodeName.toLowerCase();if(t.id)e+=`#${CSS.escape(t.id)}`;else{let l=Array.from(t.parentNode?.children||[]).filter(r=>r.nodeName===t.nodeName);if(l.length>1){let r=l.indexOf(t);e+=`:nth-of-type(${r+1})`}}i.unshift(e),t=t.parentElement}return i.join(" > ")}function O(t){if(t.id)return`//*[@id="${t.id}"]`;let i=[];for(;t&&t.nodeType===1;){let e=1,l=t.previousSibling;for(;l;)l.nodeType===1&&l.tagName===t.tagName&&e++,l=l.previousSibling;let r=t.tagName.toLowerCase(),u=e>1?`${r}[${e}]`:r;i.unshift(u),t=t.parentNode}return"/"+i.join("/")}window.getSmartSelectorLib={getSmartSelector:I,getDevtoolsLikeSelector:W};(function(){if(console.debug("[Botflows] Recorder script starting execution..."),window.__recorderInjected){console.debug(`[Botflows] Recorder already injected at ${window.__recorderInjectedTime}, skipping.`);return}window.__recorderInjected=!0,window.__recorderInjectedTime=new Date().toISOString(),console.debug("[Botflows] Recorder script injected successfully");let t={selector:null,timestamp:0},i={selector:null,timestamp:0},e=()=>window.__pickModeActive===!0;function l(){if(document.getElementById("__botflows_validation_overlay"))return;let o=document.createElement("div");o.id="__botflows_validation_overlay",Object.assign(o.style,{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",backgroundColor:"rgba(255, 255, 255, 0.6)",zIndex:999999,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"22px",fontFamily:"sans-serif",fontWeight:"bold",color:"#333"}),o.innerText="Validating action\u2026 Please wait",document.body.appendChild(o)}function r(o,a){if(document.getElementById("botflows-prompt"))return;let s=document.createElement("div");s.id="botflows-prompt",s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.width="100vw",s.style.height="100vh",s.style.backgroundColor="rgba(0,0,0,0.5)",s.style.zIndex=9999,s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.fontFamily="Arial, sans-serif",s.setAttribute("data-botflows-ui","true");let n=document.createElement("div");n.style.background="white",n.style.padding="20px",n.style.borderRadius="12px",n.style.width="460px",n.style.boxShadow="0 5px 15px rgba(0,0,0,0.3)",n.setAttribute("data-botflows-ui","true");let f=null,x="",b="regex";function h(){return f==null?"":o[f]?.preview||""}function $(d){if(!d)return"";try{if(b==="regex"){let m=new RegExp(x),v=d.match(m);return v?.[1]||v?.[0]||"(no match)"}else if(b==="js")return new Function("value",`return value${x}`)(d)}catch{return"(error)"}return d}window.getTransformedPreview=$;function E(){n.querySelector("#botflows-raw-value").textContent=h(),n.querySelector("#botflows-transformed-value").textContent=$(h())}n.innerHTML=`
      <h2 style="margin-top:0; font-size:20px; color:#333;">\u{1F501} Botflows \u2013 Map Field to Column</h2>
      <p style="margin: 10px 0;">Select a column to map this input to:</p>
      <select id="column-select" style="width:100%; padding:8px; font-size:14px;">
        <option value="">-- Skip Mapping --</option>
        ${o.map((d,m)=>`<option value="${m}">${d.label}</option>`).join("")}
      </select>
      <p style="margin: 10px 0 5px;">Transform type:</p>
      <select id="transform-type" style="width:100%; padding:8px; font-size:14px;">
        <option value="regex">Regex</option>
        <option value="js">JS Expression (e.g. .trim(), .slice(0,3))</option>
      </select>
      <p style="margin: 10px 0 5px;">Transformation rule:</p>
      <input id="transform-input" type="text" placeholder="e.g., (.+?)\\s or .trim()" style="width:100%; padding:8px; font-size:14px;" />
      <div style="margin-top:16px; font-style:italic;">
        <div>Raw: <span id="botflows-raw-value" style="font-weight:bold;"></span></div>
        <div>Result: <span id="botflows-transformed-value" style="font-weight:bold;"></span></div>
      </div>
      <div style="margin-top:20px; display: flex; justify-content: flex-end; gap: 10px;">
        <button id="cancel-btn" style="padding: 6px 12px; background: #eee; border: 1px solid #ccc;">Cancel</button>
        <button id="submit-btn" style="padding: 6px 12px; background: #2563eb; color: white; border: none;">Submit</button>
      </div>
    `,s.appendChild(n),document.body.appendChild(s),n.querySelector("#column-select").onchange=d=>{f=parseInt(d.target.value),E()},n.querySelector("#transform-input").oninput=d=>{x=d.target.value,E()},n.querySelector("#transform-type").onchange=d=>{b=d.target.value,E()},n.querySelector("#cancel-btn").onclick=()=>{document.body.removeChild(s),a(null)},n.querySelector("#submit-btn").onclick=()=>{document.body.removeChild(s),a(f!==null?{index:f,transform:x,transformType:b}:null)}}function u(o){if(!o)return[];if(o.type==="gridExtract"){debugger;return(o.columnMappings||[]).map((a,s)=>({label:`${s+1}. ${a.header?.header||"Unnamed"}`,value:a.header?.header||"",preview:a.preview||"sample"}))}return o.type==="apiExtract"?(o.fields||[]).map(a=>({label:a.path,value:a.path,preview:a.preview||"sample"})):[]}function w(){let o=document.getElementById("__botflows_validation_overlay");o&&o.remove()}window.hideValidationOverlay=w,window.showValidationOverlay=l;function C(o){return o.closest("[data-botflows-ui]")}let A=(o,a={})=>{if(window.__botflows_replaying__){console.debug("[Botflows] In replay mode \u2014 event suppressed:",o.type);return}if(e()){console.debug("[Botflows] In pick mode \u2014 event suppressed:",o.type);return}if(window.__pendingValidation){console.debug("[Botflows] Skipping event while previous validation is pending");return}let s=o.target,n=s.closest('a, button, input[type="button"], [role="button"]')||s,f=o.type;if(C(n)){console.debug("[Botflows] Skipping event from Botflows UI:",n);return}if(!n||n===document||n===document.body||!document.contains(n)||typeof window.sendEventToPython!="function"){console.debug("[Botflows] Ignoring untrackable target:",n);return}let x={tagName:n.tagName.toLowerCase(),id:n.id||null,name:n.getAttribute("name")||null,classList:Array.from(n.classList||[]),attributes:B(n),text:n.innerText?.trim()||"",elementText:n.textContent?.trim()||"",boundingBox:n.getBoundingClientRect?.(),outerHTML:n.outerHTML||"",domPath:V(n),xpath:O(n)},b=Date.now(),h=j(n).selector;if(f==="click"&&h===t.selector&&b-t.timestamp<80){console.debug("[Botflows] Suppressed duplicate click:",h);return}if(f==="focus"){let v=n.tagName.toLowerCase();if(!["input","textarea","select"].includes(v)){console.debug("[Botflows] Ignored focus event on non-input element:",v);return}}f==="click"&&(t={selector:h,timestamp:b}),f==="focus"&&(i={selector:h,timestamp:b});let $={action:f==="input"?"type":f,url:window.location.href,value:n.value||null,timestamp:b,...x},E=window.loopContext?.sourceStep,d=u(E);if(window.loopContext?.active&&d.length&&["input","select","textarea","a"].includes(n.tagName.toLowerCase())&&n.getAttribute("data-botflows-mapped")!==window.loopContext?.loopName){if(typeof n.value=="string"&&/\{\{.*\}\}/.test(n.value)){let k=n.value.match(/\{\{(.*?)\}\}/)?.[1]?.trim(),S=d.find(_=>_.value===k);if(S){n.setAttribute("data-botflows-mapped",window.loopContext?.loopName||"global"),n.setAttribute("data-dynamic-value",`{{${S.value}}}`),n.dispatchEvent(new Event("change",{bubbles:!0})),console.debug(`[Botflows] Auto-mapped input to: {{${S.value}}}`),m();return}}if(["select","a","button"].includes(n.tagName.toLowerCase())||["combobox","link","option"].includes(n.getAttribute("role"))||n.tagName.toLowerCase()==="input"){debugger;r(d,N=>{if(!N){n.setAttribute("data-botflows-mapped",window.loopContext?.loopName||"global"),m();return}let k=d[N.index],S=`{{${k.value}}}`,_=k.preview||"sample",F=N.transformType||null,R=N.transform||"",z=window.getTransformedPreview(_)||_;n.value=z,n.setAttribute("data-botflows-mapped",window.loopContext?.loopName||"global"),n.setAttribute("data-dynamic-value",S),F&&(n.setAttribute("data-transform-type",F),n.setAttribute("data-transform",R)),n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),console.debug(`[Botflows] Mapped input to: ${S} (with ${F||"no"} transform: ${R})`),m()});return}}m();function m(){console.debug("[Botflows] Sending event to Python:",$),window.__pendingValidation=!0,l(),window.sendEventToPython($),L()}};["click","focus","change","dblclick"].forEach(o=>{document.addEventListener(o,A,!0),console.debug(`[Botflows] Event listener attached for ${o}`)});function L(o=5e3){return new Promise(a=>{let s=n=>{n.data?.type==="validationComplete"&&(window.removeEventListener("message",s),window.__pendingValidation=!1,w(),a())};window.addEventListener("message",s),setTimeout(()=>{window.removeEventListener("message",s),console.warn("[Botflows] Validation timeout"),window.__pendingValidation=!1,w(),a()},o)})}let g=null,P="";function y(o){let a=o.value||"";if(a!==P){P=a;let s=new Event("input");s.target=o,A(s)}}document.addEventListener("input",o=>{if(e())return;let a=o.target;a.matches("input, textarea")&&(clearTimeout(g),g=setTimeout(()=>y(a),300))},!0),document.addEventListener("keydown",o=>{if(e())return;let a=o.target;a.matches("input, textarea")&&o.key==="Enter"&&(clearTimeout(g),y(a))},!0),document.addEventListener("blur",o=>{if(e())return;let a=o.target;a.matches("input, textarea, select")&&(clearTimeout(g),y(a))},!0);let c=window.location.href,p=()=>{let o=window.location.href;o!==c&&typeof window.sendUrlChangeToPython=="function"&&(c=o,console.debug("[Botflows] Detected SPA URL change:",o),window.sendUrlChangeToPython(o))},T=()=>{document.body?(console.debug("[Botflows] Setting up mutation observer for body"),new MutationObserver(p).observe(document.body,{childList:!0,subtree:!0})):setTimeout(T,100)};T();let M=o=>{let a=history[o];history[o]=function(...s){a.apply(this,s),console.debug(`[Botflows] Intercepted history.${o}`),p()}};window.addEventListener("popstate",p),p(),M("pushState"),M("replaceState")})();})();
