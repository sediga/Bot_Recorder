(()=>{(function(){if(window.__pickModeActive)return;window.__pickModeActive=!0,window.__picked=!1;let k="2px dashed orange",b=Array.from(document.querySelectorAll('[role="grid"], .MuiDataGrid-root, table'));function E(e){if(!e)return"";if(e.id)return`#${e.id}`;let t=[],n=e;for(;n&&n.nodeType===1&&n.tagName.toLowerCase()!=="body";){let r=n.tagName.toLowerCase();if(n.className&&typeof n.className=="string"){let u=n.className.trim().split(/\s+/).filter(Boolean).slice(0,2);u.length&&(r+="."+u.join("."))}let d=(n.parentNode?Array.from(n.parentNode.children):[]).filter(u=>u.tagName===n.tagName);if(d.length>1){let u=d.indexOf(n)+1,m=r;u>1&&(m+=`:nth-of-type(${u})`);let s=[...t].reverse().join(" > "),a=s?`${m} > ${s}`:m;document.querySelectorAll(a).length===1?r=m:r=`${r}:nth-of-type(${u})`}t.unshift(r);let y=t.join(" > ");if(document.querySelectorAll(y).length===1)break;n=n.parentElement}return n&&n.tagName.toLowerCase()==="body"&&t.unshift("body"),t.join(" > ")}function C(e){let t=Date.parse(e);return!isNaN(t)}function P(e){let t=/\b(?:\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}|\w+\s\d{1,2},\s\d{4})\b/g;return e.replace(t,"{Date}")}function N(e){if(!e||e.offsetParent===null)return!1;let t=!!e.querySelector("img, svg, use"),n=window.getComputedStyle(e).getPropertyValue("background-image"),r=n&&n!=="none"&&!n.includes("about:blank")&&!n.includes("data:image/gif")&&!n.includes("transparent"),l=e.className?.toLowerCase()||"",d=/(icon|avatar|photo|thumb|image|status|flag|badge)/.test(l),y=e.getAttribute("role")==="img"||e.getAttribute("aria-label")?.toLowerCase().includes("image");return t||r||d||y}function $(e,t){let n=new Set(["true","false","yes","no","on","off"]),r=Array.from(e.querySelectorAll('[role="row"]'));r.length===0&&(console.warn("[inferColumnType] No [role='row'] found, applying fallback..."),r.push(...e.querySelectorAll(".MuiDataGrid-row, tr"))),console.log(`[inferColumnType] Inferring type for column: ${t}`),console.log(`[inferColumnType] Total rows found (after fallback): ${r.length}`);let l=r.map(o=>{let i=o.querySelector(`[data-colindex="${t}"]`);return i||(i=Array.from(o.querySelectorAll('[role="cell"], td, th'))[t]),i?i.innerText.trim():""}).filter(o=>o.length>0).slice(0,10);console.log("[inferColumnType] Sampled Cell Texts:",l);let d=0;for(let o of r){let i=o.querySelector(`[data-colindex="${t}"]`);if(!i){let c=Array.from(o.querySelectorAll('[role="cell"], td, th'));t<c.length&&(i=c[t])}N(i)&&d++}let y=d/r.length;if(console.log(`[inferColumnType] Detected image-based column: ${d}/${r.length}`),y>=.4)return"img";if(l.length===0)return"text";let u=o=>n.has(o.toLowerCase()),m=o=>C(o),s=o=>!isNaN(parseFloat(o))&&isFinite(o),a=()=>{let o=/\b(?:\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}|\w+\s\d{1,2},\s\d{4}|\d{4}-\d{2}-\d{2}|\d{1,2}-[A-Za-z]{3}-\d{4})\b/g,i=g=>g.match(o)?.some(v=>C(v)),c=l.filter(g=>g!==""&&i(g)).length;return console.log("inferred type is text_with_date: "+c+"/"+l.length),c/l.length>=.6};return l.every(u)?"boolean":l.every(m)?"date":l.every(s)?"number":a()?"text_with_date":"text"}let S=()=>{b.forEach(e=>{e.style.outline="",e.removeEventListener("mouseover",M,!0),e.removeEventListener("mouseout",x,!0),e.removeEventListener("click",T,!0)})},M=e=>{if(!window.__pickModeActive||window.__picked)return;let t=e.currentTarget;t&&(t.style.outline="3px solid red")},x=e=>{if(!window.__pickModeActive||window.__picked)return;let t=e.currentTarget;t&&(t.style.outline=k)},T=async e=>{if(!window.__pickModeActive||window.__picked)return;e.preventDefault(),e.stopPropagation(),b.forEach(s=>s.style.outline="");let t=e.currentTarget,n=t.dataset.gridPickerIndex,r=t.outerHTML,l=t.getBoundingClientRect(),d=Array.from(t.querySelectorAll('[role="columnheader"], th')).map((s,a)=>{let o=s.innerText.trim();if(!o){let i=s.querySelector("img");if(i&&(o=i.alt||i.title||i.getAttribute("aria-label")||`Image Column ${a+1}`),!o){let c=s.className||"";c.includes("signal")?o="Signal Icon":c.includes("icon")?o="Icon Column":o=`Column ${a+1}`}}return o});console.log("[onClick] Column headers found:",d);let y=d.map((s,a)=>{let o=$(t,a),i=[];if(o==="text_with_date"){let c=Array.from(t.querySelectorAll('[role="row"]'));c.length===0&&c.push(...t.querySelectorAll(".MuiDataGrid-row, tr"));let g=new Set,p=[],v=f=>/^\d{1,2}[-/]\d{1,2}[-/]\d{2,4}$/.test(f)?"dd/MM/yyyy":/^\d{4}-\d{2}-\d{2}$/.test(f)?"yyyy-MM-dd":/^\d{2}-[A-Za-z]{3}-\d{4}$/.test(f)?"dd-MMM-yyyy":/^[A-Za-z]+\s\d{1,2},\s\d{4}$/.test(f)?"MMMM d, yyyy":"unknown",L=f=>{let h=/\b(\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}|\d{4}-\d{2}-\d{2}|\d{2}-[A-Za-z]{3}-\d{4}|\w+\s\d{1,2},\s\d{4})\b/g;return[...f.matchAll(h)].map(w=>w[1])};return c.forEach(f=>{let h=f.querySelector(`[data-colindex="${a}"]`);if(!h){let _=Array.from(f.querySelectorAll('[role="cell"], td, th'));a<_.length&&(h=_[a])}let w=h?.innerText.trim();w&&L(w).forEach(D=>{let A=v(D);g.has(A)||(g.add(A),p.push({name:`date${p.length+1}`,type:"date",format:A}))})}),{header:s,type:o,...p.length?{variables:p}:{}}}return{header:s,type:o}}),u=Array.from(t.querySelectorAll('[role="row"]')).slice(0,3).map(s=>Array.from(s.querySelectorAll('[role="cell"], td')).map(a=>a.innerText.trim())),m=E(t);typeof window.sendEventToPython=="function"&&window.sendEventToPython({type:"targetPicked",metadata:{gridId:"grid-"+n,outerHTML:r,gridSelector:m,boundingBox:{top:l.top,left:l.left,width:l.width,height:l.height},columnHeaders:y}}),window.startPicker()};b.forEach((e,t)=>{e.dataset.gridPickerIndex=t,e.style.outline=k,e.addEventListener("mouseover",M,!0),e.addEventListener("mouseout",x,!0),e.addEventListener("click",T,!0)});let q=setInterval(()=>{window.__pickModeActive||(clearInterval(q),S())},500);window.startPicker=()=>{let e=document.createElement("div");e.id="__botflows_picker_overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.zIndex="9999",e.style.backdropFilter="blur(3px)",e.style.backgroundColor="rgba(255,255,255,0.6)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.innerHTML='<div style="font-size: 20px; font-weight: bold; background: #fff; padding: 20px; border: 2px solid #333; border-radius: 10px;">Finish setup in the Botflows dashboard...</div>',document.body.appendChild(e),window.__pickModeActive=!0,window.__picked=!0},window.finishPicker=()=>{let e=document.getElementById("__botflows_picker_overlay");e&&e.remove(),window.__pickModeActive=!1,window.__picked=!1,S()}})();})();
