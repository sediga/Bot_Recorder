(()=>{(function(){if(window.__pickModeActive)return;window.__pickModeActive=!0,window.__picked=!1;let k="2px dashed orange",b=Array.from(document.querySelectorAll('[role="grid"], .MuiDataGrid-root, table'));function E(e){if(!e)return"";if(e.id)return`#${e.id}`;let t=[],n=e;for(;n&&n.nodeType===1&&n.tagName.toLowerCase()!=="body";){let i=n.tagName.toLowerCase();if(n.className&&typeof n.className=="string"){let c=n.className.trim().split(/\s+/).filter(Boolean).slice(0,2);c.length&&(i+="."+c.join("."))}let u=(n.parentNode?Array.from(n.parentNode.children):[]).filter(c=>c.tagName===n.tagName);if(u.length>1){let c=u.indexOf(n)+1,y=i;c>1&&(y+=`:nth-of-type(${c})`);let l=[...t].reverse().join(" > "),a=l?`${y} > ${l}`:y;document.querySelectorAll(a).length===1?i=y:i=`${i}:nth-of-type(${c})`}t.unshift(i);let g=t.join(" > ");if(document.querySelectorAll(g).length===1)break;n=n.parentElement}return n&&n.tagName.toLowerCase()==="body"&&t.unshift("body"),t.join(" > ")}function C(e){let t=Date.parse(e);return!isNaN(t)}function B(e){let t=/\b(?:\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}|\w+\s\d{1,2},\s\d{4})\b/g;return e.replace(t,"{Date}")}function N(e){if(!e||e.offsetParent===null)return!1;let t=!!e.querySelector("img, svg, use"),n=window.getComputedStyle(e).getPropertyValue("background-image"),i=n&&n!=="none"&&!n.includes("about:blank")&&!n.includes("data:image/gif")&&!n.includes("transparent"),s=e.className?.toLowerCase()||"",u=/(icon|avatar|photo|thumb|image|status|flag|badge)/.test(s),g=e.getAttribute("role")==="img"||e.getAttribute("aria-label")?.toLowerCase().includes("image");return t||i||u||g}function $(e,t){let n=new Set(["true","false","yes","no","on","off"]),i=Array.from(e.querySelectorAll('[role="row"]'));i.length===0&&(console.warn("[inferColumnType] No [role='row'] found, applying fallback..."),i.push(...e.querySelectorAll(".MuiDataGrid-row, tr"))),console.log(`[inferColumnType] Inferring type for column: ${t}`),console.log(`[inferColumnType] Total rows found (after fallback): ${i.length}`);let s=i.map(o=>{let r=o.querySelector(`[data-colindex="${t}"]`);return r||(r=Array.from(o.querySelectorAll('[role="cell"], td, th'))[t]),r?r.innerText.trim():""}).filter(o=>o.length>0).slice(0,10);console.log("[inferColumnType] Sampled Cell Texts:",s);let u=0;for(let o of i){let r=o.querySelector(`[data-colindex="${t}"]`);if(!r){let d=Array.from(o.querySelectorAll('[role="cell"], td, th'));t<d.length&&(r=d[t])}N(r)&&u++}let g=u/i.length;if(console.log(`[inferColumnType] Detected image-based column: ${u}/${i.length}`),g>=.4)return"img";if(s.length===0)return"text";let c=o=>n.has(o.toLowerCase()),y=o=>C(o),l=o=>!isNaN(parseFloat(o))&&isFinite(o),a=()=>{let o=/\b(?:\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}|\w+\s\d{1,2},\s\d{4}|\d{4}-\d{2}-\d{2}|\d{1,2}-[A-Za-z]{3}-\d{4})\b/g,r=f=>f.match(o)?.some(p=>C(p)),d=s.filter(f=>f!==""&&r(f)).length;return console.log("inferred type is text_with_date: "+d+"/"+s.length),d/s.length>=.6};return s.every(c)?"boolean":s.every(y)?"date":s.every(l)?"number":a()?"text_with_date":"text"}let S=()=>{b.forEach(e=>{e.style.outline="",e.removeEventListener("mouseover",M,!0),e.removeEventListener("mouseout",x,!0),e.removeEventListener("click",T,!0)})},M=e=>{if(!window.__pickModeActive||window.__picked)return;let t=e.currentTarget;t&&(t.style.outline="3px solid red")},x=e=>{if(!window.__pickModeActive||window.__picked)return;let t=e.currentTarget;t&&(t.style.outline=k)},T=async e=>{if(!window.__pickModeActive||window.__picked)return;e.preventDefault(),e.stopPropagation(),b.forEach(a=>a.style.outline="");let t=e.currentTarget,n=t.dataset.gridPickerIndex,i=t.outerHTML,s=t.getBoundingClientRect(),u=Array.from(t.querySelectorAll('[role="columnheader"], th')).map((a,o)=>{let r=a.innerText.trim();if(!r){let d=a.querySelector("img");if(d&&(r=d.alt||d.title||d.getAttribute("aria-label")||`Image Column ${o+1}`),!r){let f=a.className||"";f.includes("signal")?r="Signal Icon":f.includes("icon")?r="Icon Column":r=`Column ${o+1}`}}return r});console.log("[onClick] Column headers found:",u);let g=u.map((a,o)=>{let r=$(t,o),d=[];if(r==="text_with_date"){let f=Array.from(t.querySelectorAll('[role="row"]'));f.length===0&&f.push(...t.querySelectorAll(".MuiDataGrid-row, tr"));let v=new Set,p=[],L=m=>/^\d{1,2}[-/]\d{1,2}[-/]\d{2,4}$/.test(m)?"dd/MM/yyyy":/^\d{4}-\d{2}-\d{2}$/.test(m)?"yyyy-MM-dd":/^\d{2}-[A-Za-z]{3}-\d{4}$/.test(m)?"dd-MMM-yyyy":/^[A-Za-z]+\s\d{1,2},\s\d{4}$/.test(m)?"MMMM d, yyyy":"unknown",D=m=>{let h=/\b(\d{1,2}[\/\-.]\d{1,2}[\/\-.]\d{2,4}|\d{4}-\d{2}-\d{2}|\d{2}-[A-Za-z]{3}-\d{4}|\w+\s\d{1,2},\s\d{4})\b/g;return[...m.matchAll(h)].map(w=>w[1])};return f.forEach(m=>{let h=m.querySelector(`[data-colindex="${o}"]`);if(!h){let A=Array.from(m.querySelectorAll('[role="cell"], td, th'));o<A.length&&(h=A[o])}let w=h?.innerText.trim();w&&D(w).forEach(I=>{let _=L(I);v.has(_)||(v.add(_),p.push({name:`date${p.length+1}`,type:"date",format:_}))})}),{header:a,type:r,...p.length?{variables:p}:{}}}return{header:a,type:r}}),c=Array.from(t.querySelectorAll('[role="row"]')).slice(0,3).map(a=>Array.from(a.querySelectorAll('[role="cell"], td')).map(o=>o.innerText.trim())),y=E(t);typeof window.sendEventToPython=="function"&&window.sendEventToPython({type:"targetPicked",metadata:{gridId:"grid-"+n,outerHTML:i,gridSelector:y,boundingBox:{top:s.top,left:s.left,width:s.width,height:s.height},columnHeaders:g,rowSamples:c}});let l=document.createElement("div");l.id="__botflows_picker_overlay",l.style.position="fixed",l.style.top="0",l.style.left="0",l.style.width="100%",l.style.height="100%",l.style.zIndex="9999",l.style.backdropFilter="blur(3px)",l.style.backgroundColor="rgba(255,255,255,0.6)",l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="center",l.innerHTML='<div style="font-size: 20px; font-weight: bold; background: #fff; padding: 20px; border: 2px solid #333; border-radius: 10px;">Finish setup in the Botflows dashboard...</div>',document.body.appendChild(l),window.__picked=!0};b.forEach((e,t)=>{e.dataset.gridPickerIndex=t,e.style.outline=k,e.addEventListener("mouseover",M,!0),e.addEventListener("mouseout",x,!0),e.addEventListener("click",T,!0)});let q=setInterval(()=>{window.__pickModeActive||(clearInterval(q),S())},500);window.finishPicker=()=>{let e=document.getElementById("__botflows_picker_overlay");e&&e.remove(),window.__pickModeActive=!1,window.__picked=!1,S()}})();})();
